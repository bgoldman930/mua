*Build a program that takes the IMU input data and builds the IMU score and builds the 
*	subcomponents and the predicted score

program define buildimu
	version 15.1
	
	syntax , pov(varname numeric) inf(varname numeric) docs(varname numeric) old(varname numeric) ///
		hat(string) [keep]

	set more off
	
	* scale variables
	g 	tmp_`pov'=`pov'*100
	g 	tmp_`old'=`old'*100
	g 	tmp_`inf'=`inf'*1000
	g 	tmp_`docs'=0.61*`docs' // primary care - note this is a total guess for now

	* round variables
	replace 	tmp_`pov' = round(tmp_`pov', 0.1)
	replace 	tmp_`old' = round(tmp_`old', 0.1)
	replace 	tmp_`inf' = round(tmp_`inf', 0.1)
	replace 	tmp_`docs' = round(tmp_`docs', 0.001)


	* recode poor_share
	recode 	tmp_`pov' (0.1/2=24.6)   (2.1/4=23.7)   (4.1/6=22.8)   (6.1/8=21.9) ///
					  (8.1/10=21.0)  (10.1/12=20.0) (12.1/14=18.7) (14.1/16=17.4) ///
					  (16.1/18=16.2) (18.1/20=14.9) (20.1/22=13.6) (22.1/24=12.2) ///
					  (24.1/26=10.9) (26.1/28=9.3)  (28.1/30=7.8)  (30.1/32=6.6) ///
					  (32.1/34=5.6)  (34.1/36=4.7)  (36.1/38=3.4)  (38.1/40=2.1) ///
					  (40.1/42=1.3)  (42.1/44=1.0)  (44.1/46=0.7)  (46.1/48=0.4) ///
					  (48.1/50=0.1)  (50/100=0), gen(`pov'_imu)	
	replace `pov'_imu=25.1 if `pov'==0

	* recode share_senior
	recode tmp_`old' (0/7=20.2)   (7.1/8=20.1)   (8.1/9=19.9)   (9.1/10=19.8) ///
						(10.1/11=19.6) (11.1/12=19.4) (12.1/13=19.1) (13.1/14=18.9) ///
						(14.1/15=18.7) (15.1/16=17.8) (16.1/17=16.1) (17.1/18=14.4) ///
						(18.1/19=12.8) (19.1/20=11.1) (20.1/21=9.8)  (21.1/22=8.9) ///
						(22.1/23=8.0)  (23.1/24=7.0)  (24.1/25=6.1)  (25.1/26=5.1) ///
						(26.1/27=4.0)  (27.1/28=2.8)  (28.1/29=1.7)  (29.1/30=0.6) ///
						(30/100=0), gen(`old'_imu)	
					  
	* recode infant mortality
	recode tmp_`inf'	    (0/10=26.0)   (10.1/11=25.6)   (11.1/12=24.8)   (12.1/13=24.0) ///
						(13.1/14=23.2) (14.1/15=22.4) (15.1/16=21.5)  (16.1/17=20.5) ///
						(17.1/18=19.5) (18.1/19=18.5) (19.1/20=17.5)  (20.1/21=16.4) ///
						(21.1/22=15.3) (22.1/23=14.2) (23.1/24=13.1)  (24.1/25=11.9) ///
						(25.1/26=10.8) (26.1/27=9.6)  (27.1/28=8.5)   (28.1/29=7.3) ///
						(29.1/30=6.1)  (30.1/31=5.4)  (31.1/32=5.0)   (32.1/33=4.7) ///
						(33.1/34=4.3)  (34.1/35=4.0)  (35.1/36=3.6)   (36.1/37=3.3) ///
						(37.1/38=3.0)  (38.1/39=2.6)  (39.1/40=2.3)   (30.1/41=2.0) ///
						(41.1/42=1.8)  (42.1/43=1.6)  (43.1/44=1.4)   (44.1/45=1.2) /// 
						(45.1/46=1.0)  (46.1/47=0.8)  (47.1/48=0.6)   (48.1/49=0.3) ///
						(49.1/50=0.1)  (50/1000=0), gen(`inf'_imu)	
		

	* recode doctor density
	recode tmp_`docs'	(.001/0.05=0.5)   (.051/0.1=1.6)  (.101/0.15=2.8)   (.151/.2=4.1) ///
						(.201/.25=5.7)     (.251/.3=7.3)    (.301/.35=9.0)     (.351/.4=10.7) ///
						(.401/.45=12.6)    (.451/.5=14.8)   (.501/.55=16.9)    (.551/.6=19.1) ///
						(.601/.65=20.7)    (.651/.7=21.9)   (.701/.75=23.1)    (.751/.8=24.3) ///
						(.801/.85=25.3)    (.851/.9=25.9)   (.901/.95=26.6)    (.951/1.0=27.2) ///
						(1.001/1.05=27.7)  (1.051/1.1=28.0) (1.101/1.15=28.3)  (1.151/1.2=28.6) ///
						(1.2/1000=28.7), gen(`docs'_imu)	
						
	* create predicted imu score				
	gen 	`hat'=`pov'_imu + `old'_imu + `inf'_imu + `docs'_imu
	drop tmp_`docs' tmp_`inf' tmp_`old' tmp_`pov'
	if "`keep'"=="" drop `pov'_imu `old'_imu `inf'_imu `docs'_imu
	
end

